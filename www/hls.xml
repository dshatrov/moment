<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mync SYSTEM "entities.dtd">

<moment>
<moment_docpage/>
<content>
  <title>
    <eng>Apple HTTP Live Streaming protocol (HLS)</eng>
    <rus>Протокол Apple HTTP Live Streaming (HLS)</rus>
  </title>

  <moment_toc>
    <dl>
      <dt>
        <a href="hls.ru.html#config">Настройка</a>
      </dt>
      <dt>
        <a href="hls.ru.html#use">Использование</a>
      </dt>
      <dt>
        <a href="hls.ru.html#params">Список параметров</a>
      </dt>
    </dl>
  </moment_toc>

  <p>
    Протокол HLS используется для передачи потокового видео на мобильные устройства Apple (iPhone, iPad, Mac)
    и на устройства с ОС Android.
    Поддержку протокола HLS в видеосервере &laquo;Момент&raquo; обеспечивает модуль <i>mod_hls</i>.
  </p>

  <p>
    По протоколу HLS можно передавать видео, закодированное кодеком h.264 и звук, закодированный кодеком AAC.
    Большинство устройств поддерживают профиль "baseline" кодека h.264 (baseline profile) и звук в формате AAC LC.
    Важно следить, чтобы аудио/видеоданные в видеопотоках, раздаваемых по HLS, были закодированы именно в этих
    форматах. Например, при попытке воспроизвести видео h.264 high profile на iPhone 4 вместо видео получим
    чёрный экран.
  </p>

  <a name="config">
    <moment_section>
      Настройка
    </moment_section>
  </a>

  <p>
    В большинстве случаев <i>mod_hls</i> не требует какой-либо дополнительной настройки.
    Достаточно только убедиться в том, что он включен, т.е. что параметр
    <b>mod_hls/enable</b> имеет значение "включено".
  </p>

  <p>
    Для передачи по HLS потоков без видео или без аудио следует установить параметры
    <b>mod_hls/no_video</b> и <b>mod_hls/no_audio</b> соответственно.
  </p>

  <p>
    Пример настройки модуля <i>mod_hls:</i>
  </p>
<pre>
  mod_hls {
    enable = y
    no_audio = n
    no_video = n
  }
</pre>

  <a name="use">
    <moment_section>
      Использование
    </moment_section>
  </a>

  <p>
    Ссылки на HLS-поток имеют вид:<br/>
    <tt>http://1.2.3.4:8080/hls/test.m3u8</tt><br/>
    где "test" &mdash; имя потока, 1.2.3.4 &mdash; IP-адрес сервера, 8080 &mdash; порт moment/http_bind в конфиге.
  </p>

  <p>
    Для показа HLS-видео на веб-странице достаточно использовать тег &lt;video&gt; следующим образом:
  </p>
<pre>
  &lt;video autoplay controls src="http://1.2.3.4/hls/test.m3u8"&gt;
    <eng>Apple HLS protocol support is required to play this video.</eng><rus>Для просмотра видео требуется поддержка протокола Apple HLS.</rus>
  &lt;/video&gt;
</pre>

  <p>
    Второй вариант показа видео - через нативное приложение, написанное под конкретную мобильную платформу.
    Этот вариант хорошо подходит для показа видео как в iOS, так и на Android-устройствах.
  </p>

  <p>
    Много информации об использовании HLS можно найти
    <a href="https://developer.apple.com/streaming/">на веб-сайте Apple</a>.
  </p>

  <p>
    HTTP URI-путь <tt>/hls/</tt> зарезервирован для <i>mod_hls</i>. Этот путь нельзя использовать
    для других целей (в частности, как prefix в секции <i>mod_file</i>).
  </p>

  <a name="config">
    <moment_section>
      Список параметров
    </moment_section>
  </a>

  <p>
    Доступные параметры конфигурации модуля <i>mod_hls:</i>
  </p>

<!--  <moment_params> -->
    <p>
      <b>mod_hls/enable</b> &mdash; включить модуль <i>mod_hls</i>. По умолчанию: "yes" (<i>mod_hls</i> включен).
    </p>
    <p>
      <b>mod_hls/no_audio</b> &mdash; Не включать аудиотрек в отдаваемые HLS-потоки.
      В случае, если в HLS-потоке заявлена звуковая дорожка, но нет аудиоданных,
      воспроизведение потока в плеере начинается со значительной задержкой,
      когда плеер принимает решение начать показ видео не смотря на отсутствие ожидаемых
      аудиоданных. По умолчанию: "no" (отправлять аудио).
    </p>
    <p>
      <b>mod_hls/no_video</b> &mdash; Не включать видеотрек в отдаваемые HLS-потоки.
      В случае, если в HLS-потоке заявлено наличие видео, но нет видеоданных,
      воспроизведение потока в плеере начинается со значительной задержкой,
      когда плеер принимает решение начать показ не смотря на отсутствие ожидаемых
      видеоданных. По умолчанию: "no" (отправлять видео).
    </p>
    <p>
      <b>mod_hls/no_rtmp_audio</b> &mdash; Не включать аудио для видеопотоков,
      публикуемых на сервере RTMP-клиентами.
    </p>
    <p>
      <b>mod_hls/no_rtmp_video</b> &mdash; Не включать видео для потоков,
      публикуемых на сервере RTMP-клиентами.
    </p>
    <p>
      <b>mod_hls/stream_timeout</b> &mdash; Таймаут удаления HLS-потока на сервере, в секундах.
      В обычном режиме HLS-поток удаляется спустя stream_timeout секунд после удаления исходного
      видеопотока. До момента удаления HLS-потока клиенты ещё могут загружать хвостовые сегменты.
      В режиме "realtime" поток удаляется, если в течение интервала stream_timeout
      от клиента не поступило ни одного запроса на загрузку HLS-сегмента.
      По умолчанию: 60 секунд.
    </p>
    <p>
      <b>mod_hls/watcher_timeout</b> &mdash; таймаут в миллисекундах, используемый для определения,
      есть ли в данный момент HLS-клиенты, смотрящие конкретный видеопоток.
      Этот таймаут может использоваться при настройке подключения к источникам видео
      по запросу (см. параметр модуля <i>mod_gst</i> mod_gst/connect_on_demand)
      и при настройке включения/выключения транскодера Speex->AAC.
      По умолчанию: 5000 миллисекунд (5 секунд).
    </p>
    <p>
      <b>mod_hls/segment_duration</b> &mdash; Длительность одного HLS-сегмента в секундах.
      Это одна из основных характеристик HLS-потока (см. также параметр mod_hls/target_duration).
      Следует учитывать, что воспроизведение потока в HLS-плеерах
      не начинается до тех пор, пока клиент не загрузит полностью хотя бы один сегмент.
      Это также означает, что задержка воспроизведения видео в плеере относительно
      реального времени не может быть меньше, чем segment_duration.
      Слишком малые значения segment_duration приводят к задержкам воспроизведения на клиенте,
      перерасходу сетевого трафика, повышенной нагрузке на сервер из-за частых HTTP-запросов
      на загрузку HLS-сегментов. Значение segment_duration (а также target_duration),
      рекомендуемое Apple &mdash; не менее 10 секунд.
      По умолчанию: 1000 миллисекунд (1 секунда).
    </p>
    <p>
      <b>mod_hls/target_duration</b> &mdash;
      Значение target_duration соответствует длине HLS-сегмента в секундах.
      В большинстве случаев target_duration должно быть равно значению параметра
      mod_hls/segment_duration, поделённому на 1000 (т.к. segment_duration задаётся в миллисекундах).
      Значение target_duration помещается в поле #EXT-X-TARGETDURATION в списках HLS (m3u8),
      а также используется для определения интервалов срабатывания внутренних таймеров удаления
      старых данных видеопотока.
      По умолчанию: 1 секунда.
    </p>
    <p>
      <b>mod_hls/max_segment_len</b> &mdash; Максимальная длина HLS-сегмента в байтах.
      По умолчанию: 16777216 (16 МБ).
    </p>
    <p>
      <b>mod_hls/one_session_per_stream</b> &mdash; <i>mod_hls</i> может работать в двух режимах.
      Основной режим &mdash; общее сегментирование потока для всех клиентов (one_sssion_per_stream=y).
      В этом режиме поток разбивается на HLS-сегменты однократно, затем полученные сегменты
      рассылаются всем смотрящим клиентам. Второй режим &mdash; сегментирование потока отдельно для каждого
      клиента (one_session_per_stream=n). Этот режим позволяет уменьшить среднюю задержку
      воспроизведения потока на клиенте, при этом нагрузка на систему в расчёте на одного клиента выше.
      По умолчанию: "yes" (использовать общее сегментирование).
    </p>
    <p>
      <b>mod_hls/num_real_segments</b> &mdash; Количество заполненных сегментов с реально
      собранными (готовыми к воспроизведению) видеоданными, которые помещаются в список
      сегментов HLS, отдаваемый клиентам. Задержка воспроизведения видео в плеере
      не может быть меньше, чем segment_duration * num_real_segments. По умолчанию: 2.
    </p>
    <p>
      <b>mod_hls/num_lead_segments</b> &mdash; Количество ещё не заполненных сегментов,
      которые помещаются в хвост списка сегментов HLS, отдаваемого клиентам. По умолчанию: 1.
    </p>
    <p>
      <b>mod_hls/insert_au_delimiters</b> &mdash; Вставлять в поток дополнительные разделители
      access units. Если этот параметр не задан (значение "no"), то дополнительные разделители
      добавляются только для потоков, публикуемых на сервере RTMP-клиентами &mdash;
      этого достаточно для корректной работы во всех случаях.
      По умолчанию: "no" (не добавлять разделители).
    </p>
    <p>
      <b>mod_hls/send_codec_data</b> &mdash; Вставлять в поток настройки кодека h.264 (SPS, PPS)
      с определённом интервалом (параметр mod_hls/codec_data_interval).
      Если этот параметр не задан (значение "no"), то настройки кодека
      добавляются только для потоков, публикуемых на сервере RTMP-клиентами &mdash;
      этого достаточно для корректной работы во всех случаях.
      По умолчанию: "no" (не вставлять в поток настройки кодека).
    </p>
    <p>
      <b>mod_hls/codec_data_interval</b> &mdash; Интервал добавления настроек h.264 в поток,
      в миллисекундах. См. параметр mod_hls/send_codec_data.
      По умолчанию: 1000 миллисекунд (1 секунда).
    </p>
    <p>
      <b>mod_hls/realtime_mode</b> &mdash; в режиме "realtime" данные HLS-сегментов отправляются
      клиентам немедленно, даже если сегмент сформирован не полностью. Сегменты при этом имеют фиксированный
      размер в байтах (параметр mod_hls/realtime_target_len). На практике уменьшения задержки воспроизведения
      в этом режиме не наблюдается, т.к. плееры не начинают воспроизведение сегмента до его полной
      загрузки. Использовать режим "realtime" не рекомендуется, за исключением случаев, когда это может
      быть полезно для тестирования &mdash; например, при разработке HLS-плееров. По умолчанию: "no" (выключено).
    </p>
    <p>
      <b>mod_hls/realtime_target_len</b> &mdash; Длина HLS-сегмента в байтах в режиме "realtime"
      (см. параметр mod_hls/realtime_mode). Это число должно быть кратно 188, т.е. размеру
      пакета MPEG TS. По умолчанию: 94000 (равняется 500 * 188).
    </p>
    <p>
      <b>mod_hls/num_dummy_starters</b> &mdash; Количество пустых HLS-сегментов, состоящих из
      одного разделителя access units, помещаемых в список сегментов HLS в начале потока.
      Экспериментальный параметр. По умолчанию: 0.
    </p>
<!--  </moment_params> -->

</content>
</moment>

